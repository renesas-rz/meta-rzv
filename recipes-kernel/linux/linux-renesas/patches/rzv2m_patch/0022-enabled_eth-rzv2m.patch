From bce39292f88c34ee84d36f9b61bc0e5ed34b1e8e Mon Sep 17 00:00:00 2001
From: Canh Dao <canh.dao.ct@renesas.com>
Date: Mon, 13 Sep 2021 12:05:45 +0700
Subject: [PATCH] enabled_eth-rzv2m

Signed-off-by: Canh Dao <canh.dao.ct@renesas.com>
---
 .../dts/renesas/r9a09g011gbg-evaluation-board.dts  |  2 +-
 arch/arm64/boot/dts/renesas/r9a09g011gbg.dtsi      | 72 +++++++++++++---------
 arch/arm64/configs/defconfig                       |  3 +
 drivers/net/ethernet/renesas/ravb_main.c           |  1 +
 4 files changed, 47 insertions(+), 31 deletions(-)

diff --git a/arch/arm64/boot/dts/renesas/r9a09g011gbg-evaluation-board.dts b/arch/arm64/boot/dts/renesas/r9a09g011gbg-evaluation-board.dts
index 80e915e..a123940 100644
--- a/arch/arm64/boot/dts/renesas/r9a09g011gbg-evaluation-board.dts
+++ b/arch/arm64/boot/dts/renesas/r9a09g011gbg-evaluation-board.dts
@@ -18,7 +18,7 @@
        };
 
        chosen {
-               bootargs = "earlycon=uart,mmio32,0xA4040000,115200n8 console=ttyS0,115200n8 loglevel=8 vmalloc=384M root=/dev/mmcblk0p2 rootwait rootfstype=ext3 rw; rodata=off";
+               bootargs = "earlycon=uart,mmio32,0xA4040000,115200n8 console=ttyS0,115200n8 loglevel=8 vmalloc=384M root=/dev/mmcblk0p2 rootwait rootfstype=ext3 rw; rodata=off ip=dhcp";
                stdout-path = "serial0:115200n8";
        };
 
diff --git a/arch/arm64/boot/dts/renesas/r9a09g011gbg.dtsi b/arch/arm64/boot/dts/renesas/r9a09g011gbg.dtsi
index 6344203..e897cfa 100644
--- a/arch/arm64/boot/dts/renesas/r9a09g011gbg.dtsi
+++ b/arch/arm64/boot/dts/renesas/r9a09g011gbg.dtsi
@@ -150,6 +150,13 @@
                compatible = "fixed-clock";
                clock-frequency = <200000000>;
        };
+       ethclk: ethclk@200M {
+               #clock-cells = <0>;
+               compatible = "fixed-clock";
+               clock-frequency = <200000000>;
+       };
+
+
 #endif
 
        soc: soc {
@@ -323,31 +330,35 @@
                        compatible = "renesas,etheravb-r8arzv2m",
                                     "renesas,etheravb-rcar-gen3";
                        reg = <0 0xa3300000 0 0x800>;
-                       interrupts = <GIC_SPI 39 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 40 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 41 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 42 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 43 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 44 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 45 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 46 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 47 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 48 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 49 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 50 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 51 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 52 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 53 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 54 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 55 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 56 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 57 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 58 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 59 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 60 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 61 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 62 IRQ_TYPE_LEVEL_HIGH>,
-                                    <GIC_SPI 63 IRQ_TYPE_LEVEL_HIGH>;
+                       interrupts = <GIC_SPI 251 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 252 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 253 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 254 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 255 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 256 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 257 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 258 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 259 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 260 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 261 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 262 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 263 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 264 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 265 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 266 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 267 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 268 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 269 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 270 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 271 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 272 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 273 IRQ_TYPE_LEVEL_HIGH
+                                    GIC_SPI 275 IRQ_TYPE_LEVEL_HIGH
+                                    GIC_SPI 277 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 274 IRQ_TYPE_LEVEL_HIGH
+                                    GIC_SPI 276 IRQ_TYPE_LEVEL_HIGH
+                                    GIC_SPI 278 IRQ_TYPE_LEVEL_HIGH>,
+                                    <GIC_SPI 279 IRQ_TYPE_LEVEL_HIGH>;
                        interrupt-names = "ch0", "ch1", "ch2", "ch3",
                                          "ch4", "ch5", "ch6", "ch7",
                                          "ch8", "ch9", "ch10", "ch11",
@@ -355,12 +366,13 @@
                                          "ch16", "ch17", "ch18", "ch19",
                                          "ch20", "ch21", "ch22", "ch23",
                                          "ch24";
-                       clocks = <&cpg CPG_MOD 812>;
-                       power-domains = <&sysc R8A774C0_PD_ALWAYS_ON>;
-                       resets = <&cpg 812>;
+                       clocks = <&ethclk>;
+                       /*clocks = <&cpg CPG_MOD 812>;*/
+                       /*power-domains = <&sysc R8A774C0_PD_ALWAYS_ON>;*/
+                       /*resets = <&cpg 812>;*/
                        renesas,no-ether-link;
                        phy-handle = <&phy0>;
-                       phy-mode = "gmii";
+                       phy-mode = "rgmii";
                        #address-cells = <1>;
                        #size-cells = <0>;
                        status = "okay";
@@ -368,7 +380,7 @@
                        phy0: ethernet-phy@0 {
                                rxc-skew-ps = <1500>;
                                reg = <0>;
-                               interrupts = <21 IRQ_TYPE_LEVEL_LOW>;
+                               /*interrupts = <21 IRQ_TYPE_LEVEL_LOW>;*/
                        };
                };
 #endif
diff --git a/arch/arm64/configs/defconfig b/arch/arm64/configs/defconfig
index f3398a6..1d999f6 100644
--- a/arch/arm64/configs/defconfig
+++ b/arch/arm64/configs/defconfig
@@ -131,6 +131,7 @@ CONFIG_VIRTIO_NET=y
 CONFIG_RAVB=y
 # CONFIG_CAVIUM_PTP is not set
 CONFIG_MDIO_BUS_MUX_MMIOREG=y
+#CONFIG_MICREL_PHY=y
 CONFIG_REALTEK_PHY=y
 # CONFIG_WLAN is not set
 CONFIG_INPUT_MATRIXKMAP=y
@@ -408,3 +409,5 @@ CONFIG_DEVFREQ_GOV_USERSPACE=y
 CONFIG_DEVFREQ_GOV_PASSIVE=y
 CONFIG_E1000E=y
 CONFIG_RENESAS_MFIS_ECC=y
+#CONFIG_PHYLIB=y
+#CONFIG_MDIO_DEVICE=y
diff --git a/drivers/net/ethernet/renesas/ravb_main.c b/drivers/net/ethernet/renesas/ravb_main.c
index a455b42..f2e9646 100644
--- a/drivers/net/ethernet/renesas/ravb_main.c
+++ b/drivers/net/ethernet/renesas/ravb_main.c
@@ -1934,6 +1934,7 @@ static const struct of_device_id ravb_match_table[] = {
 	{ .compatible = "renesas,etheravb-rcar-gen2", .data = (void *)RCAR_GEN2 },
 	{ .compatible = "renesas,etheravb-r8a7795", .data = (void *)RCAR_GEN3 },
 	{ .compatible = "renesas,etheravb-rcar-gen3", .data = (void *)RCAR_GEN3 },
+        { .compatible = "renesas,renesas,etheravb-r8arzv2m", .data = (void *)RCAR_GEN3 },
 	{ }
 };
 MODULE_DEVICE_TABLE(of, ravb_match_table);
-- 
2.7.4

