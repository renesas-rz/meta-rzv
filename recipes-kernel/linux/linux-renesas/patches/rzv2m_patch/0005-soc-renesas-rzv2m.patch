From 475d4ff834f706d4a1e4438363980821a3dde622 Mon Sep 17 00:00:00 2001
From: Canh Dao <canh.dao.ct@renesas.com>
Date: Mon, 9 Aug 2021 15:34:17 +0700
Subject: [PATCH] soc renesas rzv2m

Signed-off-by: Canh Dao <canh.dao.ct@renesas.com>
---
 drivers/soc/renesas/Kconfig       |  7 ++++++-
 drivers/soc/renesas/Makefile      |  1 +
 drivers/soc/renesas/rcar-rst.c    |  1 +
 drivers/soc/renesas/rcar-sysc.c   |  7 +++++++
 drivers/soc/renesas/rcar-sysc.h   |  1 +
 drivers/soc/renesas/renesas-soc.c | 23 ++++++++++++++++++++++-
 6 files changed, 38 insertions(+), 2 deletions(-)

diff --git a/drivers/soc/renesas/Kconfig b/drivers/soc/renesas/Kconfig
index 9986531..f28ca92 100644
--- a/drivers/soc/renesas/Kconfig
+++ b/drivers/soc/renesas/Kconfig
@@ -4,7 +4,7 @@ config SOC_RENESAS
 	select SOC_BUS
 	select RST_RCAR if ARCH_RCAR_GEN1 || ARCH_RCAR_GEN2 || \
 			   ARCH_R8A774A1 || ARCH_R8A774A3 || ARCH_R8A774B1 || \
-			   ARCH_R8A774C0 || ARCH_R8A774E1 || ARCH_R8A7795 || \
+			   ARCH_R8A774C0 || ARCH_R8A774E1 || ARCH_R8A7795 || ARCH_R9A09G011GBG || \
 			   ARCH_R8A7796  || ARCH_R8A77965 || ARCH_R8A77970 || \
 			   ARCH_R8A77980 || ARCH_R8A77990 || ARCH_R8A77995
 	select SYSC_R8A7743 if ARCH_R8A7743
@@ -15,6 +15,7 @@ config SOC_RENESAS
 	select SYSC_R8A774B1 if ARCH_R8A774B1
 	select SYSC_R8A774C0 if ARCH_R8A774C0
 	select SYSC_R8A774E1 if ARCH_R8A774E1
+	select SYSC_R9A09G011GBG if ARCH_R9A09G011GBG
 	select SYSC_R8A7779 if ARCH_R8A7779
 	select SYSC_R8A7790 if ARCH_R8A7790
 	select SYSC_R8A7791 if ARCH_R8A7791 || ARCH_R8A7793
@@ -71,6 +72,10 @@ config SYSC_R8A774E1
 	bool "RZ/G2H System Controller support" if COMPILE_TEST
 	select SYSC_RCAR
 
+config SYSC_R9A09G011GBG
+       bool "RZ/V2M System Controller support" if COMPILE_TEST
+       select SYSC_RCAR
+
 config SYSC_R8A7779
 	bool "R-Car H1 System Controller support" if COMPILE_TEST
 	select SYSC_RCAR
diff --git a/drivers/soc/renesas/Makefile b/drivers/soc/renesas/Makefile
index be9024f..3bd2ed5 100644
--- a/drivers/soc/renesas/Makefile
+++ b/drivers/soc/renesas/Makefile
@@ -11,6 +11,7 @@ obj-$(CONFIG_SYSC_R8A774A3)	+= r8a774a1-sysc.o
 obj-$(CONFIG_SYSC_R8A774B1)	+= r8a774b1-sysc.o
 obj-$(CONFIG_SYSC_R8A774C0)	+= r8a774c0-sysc.o
 obj-$(CONFIG_SYSC_R8A774E1)	+= r8a774e1-sysc.o
+obj-$(CONFIG_SYSC_R9A09G011GBG)        += r9a09g011gbg-sysc.o
 obj-$(CONFIG_SYSC_R8A7779)	+= r8a7779-sysc.o
 obj-$(CONFIG_SYSC_R8A7790)	+= r8a7790-sysc.o
 obj-$(CONFIG_SYSC_R8A7791)	+= r8a7791-sysc.o
diff --git a/drivers/soc/renesas/rcar-rst.c b/drivers/soc/renesas/rcar-rst.c
index a2b3d04..05cef20 100644
--- a/drivers/soc/renesas/rcar-rst.c
+++ b/drivers/soc/renesas/rcar-rst.c
@@ -52,6 +52,7 @@ static const struct of_device_id rcar_rst_matches[] __initconst = {
 	{ .compatible = "renesas,r8a774b1-rst", .data = &rcar_rst_gen3 },
 	{ .compatible = "renesas,r8a774c0-rst", .data = &rcar_rst_gen3 },
 	{ .compatible = "renesas,r8a774e1-rst", .data = &rcar_rst_gen3 },
+	{ .compatible = "renesas,r8arzv2m-rst", .data = &rcar_rst_gen3 },
 	/* R-Car Gen1 */
 	{ .compatible = "renesas,r8a7778-reset-wdt", .data = &rcar_rst_gen1 },
 	{ .compatible = "renesas,r8a7779-reset-wdt", .data = &rcar_rst_gen1 },
diff --git a/drivers/soc/renesas/rcar-sysc.c b/drivers/soc/renesas/rcar-sysc.c
index f6dedd8..fc8b275 100644
--- a/drivers/soc/renesas/rcar-sysc.c
+++ b/drivers/soc/renesas/rcar-sysc.c
@@ -302,6 +302,9 @@ static const struct of_device_id rcar_sysc_matches[] __initconst = {
 #ifdef CONFIG_SYSC_R8A774E1
 	{ .compatible = "renesas,r8a774e1-sysc", .data = &r8a774e1_sysc_info },
 #endif
+#ifdef CONFIG_SYSC_R9A09G011GBG
+       { .compatible = "renesas,r8arzv2m-sysc", .data = &r8arzv2m_sysc_info },
+#endif
 #ifdef CONFIG_SYSC_R8A7779
 	{ .compatible = "renesas,r8a7779-sysc", .data = &r8a7779_sysc_info },
 #endif
@@ -360,6 +363,10 @@ static int __init rcar_sysc_pd_init(void)
 	unsigned int i;
 	int error;
 
+#ifdef CONFIG_SYSC_R9A09G011GBG
+		return 0;
+#endif
+
 	np = of_find_matching_node_and_match(NULL, rcar_sysc_matches, &match);
 	if (!np)
 		return -ENODEV;
diff --git a/drivers/soc/renesas/rcar-sysc.h b/drivers/soc/renesas/rcar-sysc.h
index bfbba4a..19033ef 100644
--- a/drivers/soc/renesas/rcar-sysc.h
+++ b/drivers/soc/renesas/rcar-sysc.h
@@ -61,6 +61,7 @@ extern const struct rcar_sysc_info r8a774a3_sysc_info;
 extern const struct rcar_sysc_info r8a774b1_sysc_info;
 extern const struct rcar_sysc_info r8a774c0_sysc_info;
 extern const struct rcar_sysc_info r8a774e1_sysc_info;
+extern const struct rcar_sysc_info r8arzv2m_sysc_info;
 extern const struct rcar_sysc_info r8a7779_sysc_info;
 extern const struct rcar_sysc_info r8a7790_sysc_info;
 extern const struct rcar_sysc_info r8a7791_sysc_info;
diff --git a/drivers/soc/renesas/renesas-soc.c b/drivers/soc/renesas/renesas-soc.c
index 6871f47..f36ec95 100644
--- a/drivers/soc/renesas/renesas-soc.c
+++ b/drivers/soc/renesas/renesas-soc.c
@@ -62,6 +62,11 @@ static const struct renesas_family fam_rzg2 __initconst __maybe_unused = {
 	.reg	= 0xfff00044,		/* PRR (Product Register) */
 };
 
+static const struct renesas_family fam_rzv2 __initconst __maybe_unused = {
+       .name   = "RZ/V2",
+       .reg    = 0xA3F03104,           /* SYS (Version Register) */
+};
+
 static const struct renesas_family fam_shmobile __initconst __maybe_unused = {
 	.name	= "SH-Mobile",
 	.reg	= 0xe600101c,		/* CCCR (Common Chip Code Register) */
@@ -132,6 +137,11 @@ static const struct renesas_soc soc_rz_g2h __initconst __maybe_unused = {
 	.id	= 0x4f,
 };
 
+static const struct renesas_soc soc_rz_v2m __initconst __maybe_unused = {
+       .family = &fam_rzv2,
+       .id     = 0x10,
+};
+
 static const struct renesas_soc soc_rcar_m1a __initconst __maybe_unused = {
 	.family	= &fam_rcar_gen1,
 };
@@ -247,6 +257,9 @@ static const struct of_device_id renesas_socs[] __initconst = {
 #ifdef CONFIG_ARCH_R8A774E1
 	{ .compatible = "renesas,r8a774e1",	.data = &soc_rz_g2h },
 #endif
+#ifdef CONFIG_ARCH_R9A09G011GBG
+       { .compatible = "renesas,r8arzv2m",     .data = &soc_rz_v2m },
+#endif
 #ifdef CONFIG_ARCH_R8A7778
 	{ .compatible = "renesas,r8a7778",	.data = &soc_rcar_m1a },
 #endif
@@ -313,6 +326,7 @@ static int __init renesas_soc_init(void)
 	soc = match->data;
 	family = soc->family;
 
+#ifndef CONFIG_ARCH_R9A09G011GBG
 	/* Try PRR first, then hardcoded fallback */
 	np = of_find_compatible_node(NULL, NULL, "renesas,prr");
 	if (np) {
@@ -335,7 +349,7 @@ static int __init renesas_soc_init(void)
 			return -ENODEV;
 		}
 	}
-
+#endif
 	soc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);
 	if (!soc_dev_attr)
 		return -ENOMEM;
@@ -347,10 +361,17 @@ static int __init renesas_soc_init(void)
 	soc_dev_attr->family = kstrdup_const(family->name, GFP_KERNEL);
 	soc_dev_attr->soc_id = kstrdup_const(strchr(match->compatible, ',') + 1,
 					     GFP_KERNEL);
+#ifndef CONFIG_ARCH_R9A09G011GBG
 	if (chipid)
 		soc_dev_attr->revision = kasprintf(GFP_KERNEL, "ES%u.%u",
 						   ((product >> 4) & 0x0f) + 1,
 						   product & 0xf);
+#else
+       product = 0x0;
+       soc_dev_attr->revision = kasprintf(GFP_KERNEL, "ES%u.%u",
+                                          ((product >> 4) & 0x0f) + 1,
+                                          product & 0xf);
+#endif
 
 	pr_info("Detected Renesas %s %s %s\n", soc_dev_attr->family,
 		soc_dev_attr->soc_id, soc_dev_attr->revision ?: "");
-- 
2.7.4

